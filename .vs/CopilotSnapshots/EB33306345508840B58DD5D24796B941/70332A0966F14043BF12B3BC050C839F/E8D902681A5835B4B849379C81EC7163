using System;
using System.IO;
using System.Reflection;
using Rage;
using Rage.Attributes;

[assembly: Plugin("Disable Pistol Whip", Author = "JM MM", Description = "Disables pistol-whip melee attacks while holding a pistol.")]

public static class EntryPoint
{

    public static void Main()
    {
        Game.LogTrivial("[Disable Pistol Whip] Plugin loaded.");

        Game.DisplayNotification("char_molly", "char_molly", "Shelly McTuffington", "Disable Pistol Whip", "I have given you the power to disable pistol-whip attacks. Be careful what you wish for.");

        GameFiber.StartNew(MainLoop, "DisablePistolWhipFiber");
    }

    private static void MainLoop()
    {
        while (true)
        {
            try
            {
                Ped player = Game.LocalPlayer.Character;

                if (player == null || !player.Exists())
                {
                    GameFiber.Sleep(500);
                    continue;
                }

                if (player.IsDead || !player.IsOnFoot)
                {
                    GameFiber.Sleep(500);
                    continue;
                }

                var inv = player.Inventory;
                if (inv == null)
                {
                    GameFiber.Sleep(500);
                    continue;
                }

                var equipped = inv.EquippedWeapon;
                WeaponHash currentHash = equipped != null ? equipped.Hash : 0;

                if (IsPistol(currentHash))
                {
                    Game.DisableControlAction(0, GameControl.MeleeAttackLight, true);
                    Game.DisableControlAction(0, GameControl.MeleeAttackHeavy, true);
                    Game.DisableControlAction(0, GameControl.MeleeAttackAlternate, true);

                    GameFiber.Yield();
                }
                else
                {
                    GameFiber.Sleep(200);
                }
            }
            catch (Exception ex)
            {
                Game.LogTrivial($"[Disable Pistol Whip] Exception: {ex.Message}");
                GameFiber.Sleep(500);
            }
        }
    }

    private static readonly System.Collections.Generic.HashSet<WeaponHash> PistolHashes = new System.Collections.Generic.HashSet<WeaponHash>();

    static EntryPoint()
    {
        string[] pistolNames = new[]
        {
            "Pistol",
            "PistolMk2",
            "CombatPistol",
            "APPistol",
            "SNSPistol",
            "SNSPistolMk2",
            "HeavyPistol",
            "VintagePistol",
            "MarksmanPistol",
            "Revolver",
            "RevolverMk2",
            "DoubleActionRevolver",
            "NavyRevolver",
            "CeramicPistol"
        };

        foreach (var name in pistolNames)
        {
            if (Enum.TryParse<WeaponHash>(name, out var parsed))
            {
                PistolHashes.Add(parsed);
            }
        }
    }

    private static bool IsPistol(WeaponHash hash)
    {
        return PistolHashes.Contains(hash);
    }
}