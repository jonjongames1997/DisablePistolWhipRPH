using System;
using System.IO;
using System.Reflection;
using Rage;
using Rage.Attributes;

[assembly: Plugin("Disable Pistol Whip", Author = "JM MM", Description = "Disables pistol-whip melee attacks while holding a pistol.")]

public static class EntryPoint
{
    public static void Main()
    {
        Game.LogTrivial("[Disable Pistol Whip] Plugin loaded.");

        Game.DisplayNotification("web_");

        GameFiber.StartNew(MainLoop, "DisablePistolWhipFiber");
    }

    private static void MainLoop()
    {
        while (true)
        {
            try
            {
                Ped player = Game.LocalPlayer.Character;

                if (player == null || !player.Exists())
                {
                    GameFiber.Sleep(500);
                    continue;
                }

                if (player.IsDead || !player.IsOnFoot)
                {
                    GameFiber.Sleep(500);
                    continue;
                }

                var inv = player.Inventory;
                if (inv == null)
                {
                    GameFiber.Sleep(500);
                    continue;
                }

                var equipped = inv.EquippedWeapon;
                WeaponHash currentHash = equipped != null ? equipped.Hash : 0;

                if (IsPistol(currentHash))
                {
                    Game.DisableControlAction(0, GameControl.MeleeAttackLight, true);
                    Game.DisableControlAction(0, GameControl.MeleeAttackHeavy, true);
                    Game.DisableControlAction(0, GameControl.MeleeAttackAlternate, true);

                    GameFiber.Yield();
                }
                else
                {
                    GameFiber.Sleep(200);
                }
            }
            catch (Exception ex)
            {
                Game.LogTrivial($"[Disable Pistol Whip] Exception: {ex.Message}");
                GameFiber.Sleep(500);
            }
        }
    }

    private static readonly System.Collections.Generic.HashSet<WeaponHash> PistolHashes = new System.Collections.Generic.HashSet<WeaponHash>();

    static EntryPoint()
    {
        string[] pistolNames = new[]
        {
            "Pistol",
            "PistolMk2",
            "CombatPistol",
            "APPistol",
            "SNSPistol",
            "SNSPistolMk2",
            "HeavyPistol",
            "VintagePistol",
            "MarksmanPistol",
            "Revolver",
            "RevolverMk2",
            "DoubleActionRevolver",
            "NavyRevolver",
            "CeramicPistol"
        };

        foreach (var name in pistolNames)
        {
            if (Enum.TryParse<WeaponHash>(name, out var parsed))
            {
                PistolHashes.Add(parsed);
            }
        }
    }

    private static bool IsPistol(WeaponHash hash)
    {
        return PistolHashes.Contains(hash);
    }
}

    private static void LoadConfig()
    {
        try
        {
            if (!File.Exists(ConfigPath))
            {
                SaveConfig();
                return;
            }

            foreach (var line in File.ReadAllLines(ConfigPath))
            {
                if (string.IsNullOrWhiteSpace(line))
                    continue;

                var parts = line.Split(new[] { '=' }, 2);
                if (parts.Length != 2)
                    continue;

                var key = parts[0].Trim();
                var val = parts[1].Trim();

                if (key.Equals("Enabled", StringComparison.OrdinalIgnoreCase))
                {
                    bool parsed;
                    if (bool.TryParse(val, out parsed))
                        _enabled = parsed;
                }
            }
        }
        catch (Exception ex)
        {
            Game.LogTrivial($"[Disable Pistol Whip] LoadConfig error: {ex.Message}");
        }
    }

    private static void SaveConfig()
    {
        try
        {
            File.WriteAllText(ConfigPath, $"Enabled={_enabled}");
        }
        catch (Exception ex)
        {
            Game.LogTrivial($"[Disable Pistol Whip] SaveConfig error: {ex.Message}");
        }
    }

    private static void ShowNotification(string text)
    {
        try
        {
            // Use the game's notification if available
            Game.DisplayNotification(text);
        }
        catch
        {
            Game.LogTrivial("[Disable Pistol Whip] " + text);
        }
    }
