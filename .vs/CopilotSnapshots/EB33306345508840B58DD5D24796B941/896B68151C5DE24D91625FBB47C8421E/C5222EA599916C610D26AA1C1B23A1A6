using System;
using System.IO;
using System.Reflection;
using System.Windows.Forms;
using Rage;
using Rage.Attributes;
using DisablePistolWhip;

[assembly: Plugin("Disable Pistol Whip", Author = "JM Modifications", Description = "Disables pistol-whip melee attacks while holding a pistol.")]

namespace DisablePistolWhip
{
    public static class EntryPoint
    {
        internal static readonly Config UserConfig = new();

        private static readonly string ConfigPath = Path.Combine(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) ?? ".", "DisablePistolWhip.ini");

        public static bool Enabled { get; private set; } = true;
        public static string ToggleKeyName { get; private set; } = "F7";
        public static bool NotificationsEnabled { get; private set; } = true;
        private static DateTime _lastTogglePress = DateTime.MinValue;
        private const int ToggleDebounceMs = 500;
        private static readonly System.Collections.Generic.HashSet<WeaponHash> DisabledWeaponHashes = new System.Collections.Generic.HashSet<WeaponHash>();
        private static string DisabledWeaponsRaw = null;

        public static void Main()
        {
            Game.LogTrivial("[Disable Pistol Whip] Plugin loaded.");
            Game.DisplayNotification("char_molly", "char_molly", "Stella Dimentrescu", "Disable Pistol Whip", "by JM Modifications. Disable Pistol Whip ~g~successfully~w~ loaded. BE A THUG ABOUT IT, MAH BOI.");
            EnsureConfigExists();
            LoadConfig();
            ShowNotification($"Disable Pistol Whip: {(Enabled ? "Enabled" : "Disabled")} (Console toggle: dpw)");

            GameFiber.StartNew(MainLoop, "DisablePistolWhipFiber");

            IniReflector<Config> iniReflector = new("Plugins/DisablePistolWhip.ini");
            iniReflector.Read(UserConfig, true);

            while (true)
            {
                GameFiber.Yield();

                if (Game.IsKeyDown(UserConfig.ToggleKey))
                {
                    ShowNotification($"Disable Pistol Whip: {(Enabled ? "Enabled" : "Disabled")} (Console toggle: dpw)");
                }
            }
        }


        private static void MainLoop()
        {
            while (true)
            {
                try
                {
                    Ped player = Game.LocalPlayer.Character;

                    if (player == null || !player.Exists())
                    {
                        FiberSleep(500);
                        continue;
                    }

                    if (player.IsDead || !player.IsOnFoot)
                    {
                        FiberSleep(500);
                        continue;
                    }

                    var inv = player.Inventory;
                    if (inv == null)
                    {
                        FiberSleep(500);
                        continue;
                    }

                    var equipped = inv.EquippedWeapon;
                    WeaponHash currentHash = equipped != null ? equipped.Hash : 0;

                    try
                    {
                        var keysType = Type.GetType("System.Windows.Forms.Keys, System.Windows.Forms");
                        if (keysType != null)
                        {
                            try
                            {
                                var parsedKey = Enum.Parse(keysType, ToggleKeyName, true);
                                var mi = typeof(Game).GetMethod("IsKeyDown", new[] { keysType });
                                if (mi != null)
                                {
                                    var result = mi.Invoke(null, new[] { parsedKey });
                                    if (result is bool && (bool)result && (DateTime.UtcNow - _lastTogglePress).TotalMilliseconds > ToggleDebounceMs)
                                    {
                                        _lastTogglePress = DateTime.UtcNow;
                                        ToggleEnabled();
                                        FiberSleep(300);
                                    }
                                }
                            }
                            catch
                            {
                                // ignore parse/invoke errors
                            }
                        }
                    }
                    catch
                    {
                        // ignore if reflection fails
                    }

                    if (Enabled && IsPistol(currentHash))
                    {
                        Game.DisableControlAction(0, GameControl.MeleeAttackLight, true);
                        Game.DisableControlAction(0, GameControl.MeleeAttackHeavy, true);
                        Game.DisableControlAction(0, GameControl.MeleeAttackAlternate, true);

                        GameFiber.Yield();
                    }
                    else
                    {
                        FiberSleep(200);
                    }
                }
                catch (Exception ex)
                {
                    Game.LogTrivial($"[Disable Pistol Whip] Exception: {ex.Message}");
                    FiberSleep(500);
                }
            }
        }

        private static readonly System.Collections.Generic.HashSet<WeaponHash> PistolHashes = new System.Collections.Generic.HashSet<WeaponHash>();

        static EntryPoint()
        {
            string[] pistolNames = new[]
            {
                "Pistol",
                "PistolMk2",
                "CombatPistol",
                "APPistol",
                "SNSPistol",
                "SNSPistolMk2",
                "HeavyPistol",
                "VintagePistol",
                "MarksmanPistol",
                "Revolver",
                "RevolverMk2",
                "DoubleActionRevolver",
                "NavyRevolver",
                "CeramicPistol",
                "StunGun",
                "FlareGun",
                "Pistol50",
                "MachinePistol",
                "MicroSMG",
                "SMG",
                "SMGMk2",
                "AssaultSMG"
            };

            foreach (var name in pistolNames)
            {
                if (Enum.TryParse<WeaponHash>(name, out var parsed))
                {
                    PistolHashes.Add(parsed);
                }
            }
        }

        private static bool IsPistol(WeaponHash hash)
        {
            return PistolHashes.Contains(hash);
        }

        private static void LoadConfig()
        {
            try
            {
                if (!File.Exists(ConfigPath))
                {
                    SaveConfig();
                    return;
                }

                foreach (var line in File.ReadAllLines(ConfigPath))
                {
                    if (string.IsNullOrWhiteSpace(line))
                        continue;

                    var parts = line.Split(new[] { '=' }, 2);
                    if (parts.Length != 2)
                        continue;

                    var key = parts[0].Trim();
                    var val = parts[1].Trim();

                    if (key.Equals("Enabled", StringComparison.OrdinalIgnoreCase))
                    {
                        bool parsed;
                        if (bool.TryParse(val, out parsed))
                            Enabled = parsed;
                    }
                    else if (key.Equals("ToggleKey", StringComparison.OrdinalIgnoreCase) || key.Equals("ToggleKeyName", StringComparison.OrdinalIgnoreCase))
                    {
                        ToggleKeyName = val;
                    }
                    else if (key.Equals("Notifications", StringComparison.OrdinalIgnoreCase) || key.Equals("NotificationsEnabled", StringComparison.OrdinalIgnoreCase))
                    {
                        bool parsed;
                        if (bool.TryParse(val, out parsed))
                            NotificationsEnabled = parsed;
                    }
                }
            }
            catch (Exception ex)
            {
                Game.LogTrivial($"[Disable Pistol Whip] LoadConfig error: {ex.Message}");
            }
        }

        private static void SaveConfig()
        {
            try
            {
                // write a simple INI with a comment for users
                string[] lines = new string[]
                {
                    "; DisablePistolWhip configuration",
                    "; Enabled = true/false",
                    "Enabled=" + Enabled.ToString().ToLower(),
                    "; ToggleKey = name of key from System.Windows.Forms.Keys (e.g. F7)",
                    "ToggleKey=" + ToggleKeyName,
                    "; Notifications = true/false (show in-game notifications)",
                    "Notifications=" + NotificationsEnabled.ToString().ToLower()
                };

                File.WriteAllLines(ConfigPath, lines);
            }
            catch (Exception ex)
            {
                Game.LogTrivial($"[Disable Pistol Whip] SaveConfig error: {ex.Message}");
            }
        }

        private static void EnsureConfigExists()
        {
            try
            {
                if (!File.Exists(ConfigPath))
                {
                    File.WriteAllLines(ConfigPath, new[]
                    {
                        "; DisablePistolWhip configuration",
                        "; Set Enabled to true or false and save the file",
                        "Enabled=true"
                    });
                }
            }
            catch (Exception ex)
            {
                Game.LogTrivial($"[Disable Pistol Whip] EnsureConfigExists error: {ex.Message}");
            }
        }

        private static void ShowNotification(string text)
        {
            try
            {
                if (NotificationsEnabled)
                {
                    Game.DisplayNotification(text);
                }
                else
                {
                    Game.LogTrivial("[Disable Pistol Whip] " + text);
                }
            }
            catch
            {
                Game.LogTrivial("[Disable Pistol Whip] " + text);
            }
        }

        public static void ToggleEnabled()
        {
            Enabled = !Enabled;
            SaveConfig();
            ShowNotification($"Disable Pistol Whip: {(Enabled ? "Enabled" : "Disabled")}");
            Game.LogTrivial($"[Disable Pistol Whip] Toggled to: {Enabled}");
        }

        public static void SetToggleKeyName(string keyName)
        {
            if (string.IsNullOrWhiteSpace(keyName))
                return;

            var trimmed = keyName.Trim();
            // Validate against System.Windows.Forms.Keys enum if available at runtime
            try
            {
                var keysType = Type.GetType("System.Windows.Forms.Keys, System.Windows.Forms");
                if (keysType != null)
                {
                    try
                    {
                        // will throw if not valid
                        Enum.Parse(keysType, trimmed, true);
                        ToggleKeyName = trimmed;
                        SaveConfig();
                        ShowNotification($"Toggle key set to: {ToggleKeyName}");
                    }
                    catch
                    {
                        Game.LogTrivial($"[Disable Pistol Whip] Invalid toggle key name: {trimmed}");
                        ShowNotification($"Invalid key: {trimmed}");
                    }
                }
                else
                {
                    ToggleKeyName = trimmed;
                    SaveConfig();
                    ShowNotification($"Toggle key set to: {ToggleKeyName} (unvalidated)");
                }
            }
            catch (Exception ex)
            {
                Game.LogTrivial($"[Disable Pistol Whip] SetToggleKeyName error: {ex.Message}");
            }
        }

        public static void SetNotificationsEnabled(bool enabled)
        {
            NotificationsEnabled = enabled;
            SaveConfig();
            ShowNotification($"Notifications {(NotificationsEnabled ? "enabled" : "disabled")}");
        }

        private static void FiberSleep(int ms)
        {
            try
            {
                GameFiber.Sleep(ms);
            }
            catch (InvalidOperationException)
            {
                System.Threading.Thread.Sleep(ms);
            }
        }
    }
}